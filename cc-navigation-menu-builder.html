<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Navigation Menu Builder</title>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<style>
  :root { --line:#22304c; --left:560px; }
  *{box-sizing:border-box}
  body{margin:0;color:#e5e7eb;background:linear-gradient(180deg,#0b1220 0%,#0a0f1a 100%);font:14px/1.4 system-ui,-apple-system,Segoe UI,Inter,Roboto,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px}
  header h1{margin:0;font-size:16px;font-weight:600}
  header .actions{margin-left:auto;display:flex;gap:8px;align-items:center}
  button,select,input[type="text"],input[type="url"],input[type="color"],input[type="number"],textarea{
    background:#0f172a;color:#e5e7eb;border:1px solid #23324e;border-radius:4px;padding:8px 10px;font:inherit
  }
  button{cursor:pointer;transition:.15s transform}
  button:hover{transform:translateY(-1px);border-color:#355188}
  button.ghost{background:transparent}
  .pill{padding:4px 8px;border-radius:4px;border:1px solid #203050;background:#0c1427;font-size:12px;color:#cbd5e1}
  .danger{border-color:#4b1f2a;background:#281018;color:#fca5a5}

  /* Overflow "More" menu */
  .menu-wrap { position:relative; }
  .menu-wrap .menu{
    position:absolute; right:0; top:100%; margin-top:8px;
    background:#0c1426; border:1px solid #23324e; border-radius:10px;
    padding:8px; display:none; z-index:9999; min-width:190px;
  }
  .menu-wrap .menu button{ display:block; width:100%; text-align:left; margin:2px 0; }
  .menu-wrap.open .menu{ display:block; }

  /* Split layout */
  .layout{
    display:grid;
    grid-template-columns: var(--left, 560px) 10px 1fr;
    gap:16px;
    padding:16px;
  }
  .divider{
    align-self:stretch; cursor:col-resize; border-radius:8px;
    background:linear-gradient(180deg,#0e162b,#0c1426); border:1px solid #23324e; position:relative;
  }
  .divider::after{ content:""; position:absolute; inset:10% 3px; border-left:2px dotted #355188; opacity:.8; }
  .divider:hover{ border-color:#355188; }
  @media (max-width:980px){ .layout{ grid-template-columns:1fr; } .divider{ display:none; } }

  .panel{border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,#0c1426,#0b1322);overflow:hidden;display:flex;flex-direction:column;min-height:70vh}
  .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:13px;color:#cbd5e1;background:#0d1629}
  .panel .content{padding:12px;overflow:auto}
  .toolbar{padding:10px 12px;border-top:1px solid var(--line);display:flex;gap:12px;flex-direction:column}
  .empty{color:#94a3b8;border:1px dashed #334e7b;border-radius:10px;padding:12px;text-align:center}

  /* sub-toolbar inside editor */
  #editor .subactions{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; padding:10px 12px; border-bottom:1px solid #23324e;
    background:#0d1629;
  }
  #editor .subactions .left-tools,
  #editor .subactions .right-tools { display:flex; gap:8px; align-items:center; }

  .tree{list-style:none;padding-left:0;margin:0}
  .tree ul{list-style:none;padding-left:22px;margin:6px 0 0;border-left:1px dashed #243453}
  .tree.children{min-height:10px}
  .tree.children:empty::before{content:"Drop to nest";font-size:11px;color:#7c8aa5;padding-left:4px}
  .node{display:flex;flex-direction:column;gap:8px;margin-bottom:10px;padding:10px;background:#0f192f;border:1px solid #1b2a4a;border-radius:10px;overflow:visible}
  .nodeHead{display:flex;align-items:center;gap:8px}
  .dragHandle{cursor:grab;user-select:none;padding:4px 6px;border:1px dashed #31466f;border-radius:6px;color:#93c5fd}
  .nodeHead .label{display:grid;grid-template-columns:1fr 1fr;gap:8px;flex:1}
  @media (max-width:980px){.nodeHead .label{grid-template-columns:1fr}}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row>*{flex:1 1 auto}
  .row .tight{flex:0 0 auto}

  /* Twirl/collapse */
  .nodeHead .twirl{cursor:pointer;user-select:none;padding:4px 6px;border:1px solid #31466f;background:#0b1322;border-radius:6px;color:#cbd5e1}
  .twirl .car{ display:inline-block; transition:transform .15s ease; }
  li.collapsed > .node .row { display:none; }
  li.collapsed > ul.children { display:none; }
  li.collapsed .twirl .car{ transform:rotate(-90deg); }

  /* Preview */
  .previewWrap{padding:16px;overflow:visible}
  .preview-bar{position:relative;display:flex;gap:18px;align-items:center;padding:14px 16px;border:1px solid #243453;border-radius:12px;background:#0e162b;overflow:visible}
  .preview-item{position:relative}
  .preview-link{display:inline-flex;gap:6px;align-items:center;text-decoration:none;padding:6px 10px;border-radius:8px;transition:all .2s}
  .caret{font-size:10px;opacity:.8}
  .anim-underline .preview-link{position:relative}
  .anim-underline .preview-link::after{content:"";position:absolute;left:10px;right:10px;bottom:3px;height:2px;background:currentColor;transform:scaleX(0);transform-origin:left;transition:transform .22s ease}
  .anim-underline .preview-link:hover::after{transform:scaleX(1)}
  .anim-rise .preview-link:hover{transform:translateY(-2px)}
  .anim-pulse .preview-link:hover{filter:brightness(1.2)}
  .preview-item > ul{display:none; position:absolute; left:0; top:calc(100% - 2px); margin-top:0px; padding-top:6px; list-style:none; border:1px solid #243453; border-radius:10px; background:#0d1529; min-width:220px; z-index:9999; overflow:visible;}
  .preview-item:hover > ul,.preview-item > ul:hover{ display:block; }
  .preview-item > ul li{ position:relative; margin:4px 0; }
  .preview-item > ul li > ul{ display:none; position:absolute; left:100%; top:0; margin-left:-2px; padding:10px; list-style:none; border:1px solid #243453; border-radius:10px; background:#0d1529; min-width:220px; z-index:9999; }
  .preview-item > ul li:hover > ul,.preview-item > ul li > ul:hover{ display:block; }
  .previewWrap { position: relative; z-index: 1; }
  .preview-bar  { position: relative; z-index: 2; }

  .small{font-size:12px;color:#9aa7bd}
  .layout > .panel:nth-of-type(2), .layout > .panel:nth-of-type(2) .content { overflow: visible; }

  /* Import box */
  details.importBox{border:1px solid #243453;border-radius:10px;background:#0c1426;padding:10px}
  details.importBox > summary{cursor:pointer;list-style:none;display:flex;align-items:center;gap:8px}
  details.importBox > summary::marker{display:none}
  .modeRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
  .stack{display:flex;flex-direction:column;gap:8px}
  .hidden{display:none !important}
  textarea.importArea{width:100%; min-height:140px; resize:vertical}
  .hint{font-size:12px;color:#93a4c4}
  details.adv{margin-top:8px}
  details.adv > summary{cursor:pointer;list-style:none;color:#bcd0ff}
  details.adv > summary::marker{display:none}
</style>
</head>
<body>
<header>
  <h1>üß≠ Navigation Menu Builder</h1>
  <div class="actions">
    <span class="pill" id="status">Ready</span>
    <button id="exportCC" title="Export for Gainsight Customer Community">Export Gainsight CC</button>
    <div class="menu-wrap">
      <button id="moreBtn" class="ghost" title="More exports">‚ãØ</button>
      <div id="moreMenu" class="menu">
        <button id="exportJson">Export JSON</button>
        <button id="exportHtml">Export HTML/CSS</button>
      </div>
    </div>
    <button id="reset" class="ghost">Reset</button>
  </div>
</header>

<div class="layout">
  <!-- Left -->
  <section class="panel" id="editor">
    <h2>Structure & Properties</h2>
    <div class="subactions">
      <div class="left-tools">
        <button id="undo" title="Undo (Ctrl/Cmd+Z)">Undo</button>
        <button id="redo" title="Redo (Ctrl/Cmd+Shift+Z)" disabled>Redo</button>
      </div>
      <div class="right-tools">
        <button id="addRoot">+ Add root item</button>
      </div>
    </div>

    <div class="content">
      <ul id="treeRoot" class="tree"></ul>
      <div id="emptyState" class="empty">No items yet. Click ‚ÄúAdd root item‚Äù.</div>
    </div>

    <div class="toolbar">
      <div class="pill">Drag by the handle (‚â°) ‚Ä¢ Drop anywhere to reorder or nest</div>
      <div class="pill">Fields: Label, Href, Target, Colors, Anim, Roles (IDs) ‚Ä¢ Root: Position</div>

      <details class="importBox" open>
        <summary>‚¨áÔ∏è Import from Gainsight HTML</summary>
        <div class="stack">
          <div class="modeRow">
            <label>Source</label>
            <select id="importMode">
              <option value="paste" selected>Paste HTML</option>
              <option value="file">HTML File</option>
            </select>
            <button id="runImport">Import</button>
          </div>

          <div id="pasteMode" class="modeContent">
            <textarea id="htmlPaste" class="importArea" placeholder="Paste your &lt;nav&gt; HTML from Gainsight CC‚Ä¶"></textarea>
            <div class="hint">We group by section headers (anchors containing &lt;strong&gt;), e.g., Concur Expense ‚Üí Show &amp; Tell, Discussions, Welcome‚Ä¶</div>
          </div>

          <div id="fileMode" class="modeContent hidden">
            <input type="file" id="htmlFile" accept=".html,.htm,text/html" />
            <div class="hint">Pick an HTML file that contains your nav markup.</div>
          </div>

          <details class="adv">
            <summary>Advanced options</summary>
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:8px;">
              <label><input type="checkbox" id="replaceCurrent"> Replace current items</label>
            </div>
          </details>
        </div>
      </details>
    </div>
  </section>

  <!-- Divider -->
  <div class="divider" id="divider" title="Drag to resize"></div>

  <!-- Right -->
  <section class="panel">
    <h2>Live Preview</h2>
    <div class="content previewWrap">
      <div id="preview" class="preview-bar anim-underline"></div>
      <div class="small" style="margin-top:8px">Hover items with a ‚ñæ caret to see nested children.</div>
      <div class="row" style="margin-top:12px;">
        <label class="pill tight">Global animation
          <select id="globalAnim" style="margin-left:8px;">
            <option value="anim-underline">Underline</option>
            <option value="anim-rise">Rise</option>
            <option value="anim-pulse">Pulse</option>
            <option value="">None</option>
          </select>
        </label>
      </div>
    </div>
  </section>
</div>

<script>
/* ================== State & persistence ================== */
let menu = load() || [];
const els = {
  treeRoot: document.getElementById('treeRoot'),
  preview: document.getElementById('preview'),
  addRoot: document.getElementById('addRoot'),
  exportJson: document.getElementById('exportJson'),
  exportHtml: document.getElementById('exportHtml'),
  exportCC: document.getElementById('exportCC'),
  reset: document.getElementById('reset'),
  empty: document.getElementById('emptyState'),
  globalAnim: document.getElementById('globalAnim'),
  undo: document.getElementById('undo'),
  redo: document.getElementById('redo'),
  status: document.getElementById('status'),
  divider: document.getElementById('divider'),
  importMode: document.getElementById('importMode'),
  runImport: document.getElementById('runImport'),
  fileMode: document.getElementById('fileMode'),
  pasteMode: document.getElementById('pasteMode'),
  htmlFile: document.getElementById('htmlFile'),
  htmlPaste: document.getElementById('htmlPaste'),
  replaceCurrent: document.getElementById('replaceCurrent'),
  moreBtn: document.getElementById('moreBtn'),
  moreMenu: document.getElementById('moreMenu')
};
function uid(){ return Math.random().toString(36).slice(2,9); }
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function save(){ localStorage.setItem('nav_builder_menu', JSON.stringify(menu)); }
function load(){ try{ return JSON.parse(localStorage.getItem('nav_builder_menu')); }catch(e){ return null; } }
function setStatus(t){ els.status.textContent=t; clearTimeout(setStatus._t); setStatus._t=setTimeout(()=>els.status.textContent='Ready',900); }

/* ================== Undo / Redo ================== */
const history = { past: [], future: [], isApplying:false };
function historyPush(snap){ if(history.isApplying) return; const last=history.past.at(-1); if(JSON.stringify(last)===JSON.stringify(snap)) return; history.past.push(deepClone(snap)); history.future=[]; updateUndoRedoButtons(); }
function doUndo(){ if(history.past.length<2) return; history.isApplying=true; const cur=history.past.pop(); history.future.push(cur); const prev=history.past.at(-1); menu=deepClone(prev); save(); renderAll(); history.isApplying=false; updateUndoRedoButtons(); }
function doRedo(){ if(!history.future.length) return; history.isApplying=true; const next=history.future.pop(); history.past.push(next); menu=deepClone(next); save(); renderAll(); history.isApplying=false; updateUndoRedoButtons(); }
function initHistory(){ history.past=[deepClone(menu)]; history.future=[]; updateUndoRedoButtons(); }
function updateUndoRedoButtons(){ els.undo.disabled=history.past.length<2; els.redo.disabled=history.future.length===0; }
function markDirty(){ save(); renderPreview(); historyPush(menu); setStatus('Saved'); }
window.addEventListener('keydown', (e)=>{ const z=/^z$/i.test(e.key), y=/^y$/i.test(e.key); if((e.ctrlKey||e.metaKey)&&z&&!e.shiftKey){e.preventDefault();doUndo();} else if((e.ctrlKey||e.metaKey)&&((e.shiftKey&&z)||y)){e.preventDefault();doRedo();}});
els.undo.addEventListener('click', doUndo);
els.redo.addEventListener('click', doRedo);

/* ================== CRUD ================== */
function addItem(parentId=null){
  const node = { id: uid(), label:"New Item", href:"#", target:"_self", color:"#e5e7eb", bg:"", anim:"inherit", roles:[], children:[] };
  if(parentId){ const p=findNode(menu,parentId); p&&p.children.push(node); }
  else { node.position = (Math.max(...(menu.map(m=>m.position||0)), 9)+1); menu.push(node); }
  save(); renderAll(); historyPush(menu);
}
function removeItem(id){
  function recur(arr){ const i=arr.findIndex(x=>x.id===id); if(i>-1){arr.splice(i,1); return true;} return arr.some(x=>recur(x.children)); }
  recur(menu); save(); renderAll(); historyPush(menu);
}
function findNode(arr,id){ for(const n of arr){ if(n.id===id) return n; const f=findNode(n.children,id); if(f) return f; } return null; }
function csvToArray(v){ return (v||"").split(',').map(x=>x.trim()).filter(Boolean); }
function escapeHtml(s){ return (s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }

/* ================== Render: Tree & Preview ================== */
function renderAll(){ els.empty.style.display = menu.length ? 'none':'block'; renderTree(); renderPreview(); }

function nodeTemplate(item, isRoot){
  const rolesCsv = (item.roles||[]).join(', ');
  const posField = isRoot ? `
    <label class="pill tight">Position
      <input type="number" name="position" value="${item.position ?? ''}" style="margin-left:8px;width:100px">
    </label>` : '';
  const bgValueForInput = (item.bg && item.bg.startsWith('#')) ? item.bg : '#000000';
  return `
    <div class="node" data-node="${item.id}">
      <div class="nodeHead">
        <button class="twirl" title="Collapse/expand"><span class="car">${item._collapsed ? '‚ñ∏' : '‚ñæ'}</span></button>
        <span class="dragHandle" title="Drag to move">‚â°</span>
        <div class="label">
          <input type="text" name="label" placeholder="Label" value="${escapeHtml(item.label||'')}" />
          <input type="url" name="href" placeholder="https://..." value="${escapeHtml(item.href||'')}" />
        </div>
        <button class="addChild" title="Add child">Ôºã</button>
        <button class="delete danger" title="Delete">‚úï</button>
      </div>
      <div class="row">
        <select name="target" title="Open behavior" class="tight">
          <option value="_self"  ${item.target==="_self"?'selected':''}>Same tab</option>
          <option value="_blank" ${item.target==="_blank"?'selected':''}>New tab</option>
        </select>
        <label class="pill tight">Text
          <input type="color" name="color" value="${item.color||'#e5e7eb'}" style="margin-left:8px">
        </label>
        <label class="pill tight">Background
          <input type="color" name="bg" value="${bgValueForInput}" style="margin-left:8px">
        </label>
        <label class="pill tight">Anim
          <select name="anim" style="margin-left:8px">
            <option value="inherit"   ${item.anim==='inherit'?'selected':''}>Inherit</option>
            <option value="underline" ${item.anim==='underline'?'selected':''}>Underline</option>
            <option value="rise"      ${item.anim==='rise'?'selected':''}>Rise</option>
            <option value="pulse"     ${item.anim==='pulse'?'selected':''}>Pulse</option>
            <option value="none"      ${item.anim==='none'?'selected':''}>None</option>
          </select>
        </label>
        <label class="pill" style="flex:1">Roles
          <input type="text" name="roles" placeholder="e.g. 10, 11, 12" value="${escapeHtml(rolesCsv)}" style="margin-left:8px;width:100%">
        </label>
        ${posField}
      </div>
    </div>`;
}

function wireNode(li, item, isRoot){
  const $=sel=>li.querySelector(sel);
  const on=(sel,ev,fn)=>{ const el=$(sel); if(el) el.addEventListener(ev,fn); };
  on('input[name="label"]','input',e=>{ item.label=e.target.value; markDirty(); });
  on('input[name="href"]','input',e=>{ item.href=e.target.value; markDirty(); });
  on('select[name="target"]','change',e=>{ item.target=e.target.value; markDirty(); });
  on('input[name="color"]','input',e=>{ item.color=e.target.value; markDirty(); });
  on('input[name="bg"]','input',e=>{ item.bg=e.target.value==='#000000' ? '' : e.target.value; markDirty(); });
  on('select[name="anim"]','change',e=>{ item.anim=e.target.value; markDirty(); });
  on('input[name="roles"]','input',e=>{ item.roles = csvToArray(e.target.value); markDirty(); });
  if(isRoot){ on('input[name="position"]','input',e=>{ item.position = Number(e.target.value)||0; markDirty(); }); }
  on('.addChild','click',()=>addItem(item.id));
  on('.delete','click',()=>removeItem(item.id));
  on('.twirl','click',(e)=>{
    const collapse = !(item._collapsed === true);
    item._collapsed = collapse;
    li.classList.toggle('collapsed', collapse);
    if (e.altKey && item.children?.length){
      const toggleBranch = (nodes, state) => {
        nodes.forEach(n => {
          n._collapsed = state;
          const subLi = els.treeRoot.querySelector(`li[data-id="${n.id}"]`);
          if (subLi) subLi.classList.toggle('collapsed', state);
          if (n.children?.length) toggleBranch(n.children, state);
        });
      };
      toggleBranch(item.children, collapse);
    }
    const car = li.querySelector('.twirl .car');
    if (car) car.textContent = collapse ? '‚ñ∏' : '‚ñæ';
    markDirty();
  });
}

function renderTree(){
  els.treeRoot.innerHTML = "";
  function createNode(item, isRoot){
    const li=document.createElement('li');
    li.dataset.id=item.id;
    li.innerHTML = nodeTemplate(item, isRoot);
    if (item._collapsed) li.classList.add('collapsed');
    wireNode(li, item, isRoot);
    const childUl=document.createElement('ul'); childUl.className="tree children"; childUl.dataset.list="true";
    li.appendChild(childUl);
    (item.children||[]).forEach(ch => childUl.appendChild(createNode(ch,false)));
    new Sortable(childUl,{ group:{name:'menu',pull:true,put:true}, handle:'.dragHandle', animation:150, fallbackOnBody:true, swapThreshold:.65, ghostClass:'dragGhost', onEnd:onDragEnd });
    return li;
  }
  const top=document.createElement('ul'); top.className="tree"; top.dataset.list="true";
  menu.forEach(root => top.appendChild(createNode(root,true)));
  els.treeRoot.appendChild(top);
  new Sortable(top,{ group:{name:'menu',pull:true,put:true}, handle:'.dragHandle', animation:150, fallbackOnBody:true, swapThreshold:.65, ghostClass:'dragGhost', onEnd:onDragEnd });
}

function onDragEnd(){
  const newMenu = domToTree(els.treeRoot);
  if(JSON.stringify(newMenu)!==JSON.stringify(menu)){
    menu=newMenu; save(); renderAll(); historyPush(menu);
  }
}
function domToTree(root){
  const topUl = root.querySelector(':scope > ul') || root;
  function walk(ul){
    const arr=[];
    ul.querySelectorAll(':scope > li').forEach(li=>{
      const id=li.querySelector('.node').dataset.node;
      const original=findNode(menu,id)||{};
      const node={...original, children:[]};
      const childUl=li.querySelector(':scope > ul.children');
      if(childUl){ node.children = walk(childUl); }
      arr.push(node);
    });
    return arr;
  }
  return walk(topUl);
}

/* ================== Preview ================== */
function renderPreview(){
  const cls = ['preview-bar'];
  const global = els.globalAnim.value || '';
  if (global) cls.push(global);
  els.preview.className = cls.join(' ');
  els.preview.innerHTML = "";
  if (!menu.length) { els.preview.innerHTML = '<div class="small">No items yet.</div>'; return; }

  const animToClass = (choice, global) => {
    const map = { underline:'anim-underline', rise:'anim-rise', pulse:'anim-pulse', none:'' };
    return choice === 'inherit' ? (global || '') : (map[choice] || '');
  };
  const makeLink = (item) => {
    const a = document.createElement('a');
    a.className = 'preview-link';
    a.textContent = item.label || 'Untitled';
    a.href = item.href || '#';
    a.target = item.target || '_self';
    a.style.color = item.color || '';
    a.style.background = item.bg ? item.bg : 'transparent';
    if (item.children && item.children.length) {
      const caret = document.createElement('span');
      caret.className = 'caret';
      caret.textContent = ' ‚ñæ';
      a.appendChild(caret);
    }
    return a;
  };
  const buildUL = (items) => {
    const ul = document.createElement('ul');
    items.forEach(it => {
      const li = document.createElement('li');
      const animClass = animToClass(it.anim, global);
      const link = makeLink(it);
      if (animClass) { const span = document.createElement('span'); span.className = animClass; span.appendChild(link); li.appendChild(span); }
      else { li.appendChild(link); }
      if (it.children && it.children.length) { li.appendChild(buildUL(it.children)); }
      ul.appendChild(li);
    });
    return ul;
  };
  const topFrag = document.createDocumentFragment();
  menu.forEach(root => {
    const wrap = document.createElement('div');
    wrap.className = 'preview-item';
    const animClass = animToClass(root.anim, global);
    const link = makeLink(root);
    if (animClass) { const span = document.createElement('span'); span.className = animClass; span.appendChild(link); wrap.appendChild(span); }
    else { wrap.appendChild(link); }
    if (root.children && root.children.length) { wrap.appendChild(buildUL(root.children)); }
    topFrag.appendChild(wrap);
  });
  els.preview.appendChild(topFrag);
  wirePreviewIntent(els.preview);
}
function wirePreviewIntent(container){
  const OPEN_DELAY=80, CLOSE_DELAY=250;
  const owners=[...container.querySelectorAll('.preview-item'), ...container.querySelectorAll('.preview-item > ul li')].filter(el=>el.querySelector(':scope > ul'));
  owners.forEach(el=>{
    let openT=null, closeT=null;
    const open=()=>{ clearTimeout(closeT); if(!el.classList.contains('open')) openT=setTimeout(()=>el.classList.add('open'),OPEN_DELAY); };
    const close=()=>{ clearTimeout(openT); closeT=setTimeout(()=>el.classList.remove('open'),CLOSE_DELAY); };
    el.addEventListener('mouseenter',open); el.addEventListener('mouseleave',close);
    const submenu=el.querySelector(':scope > ul'); if(submenu){ submenu.addEventListener('mouseenter',()=>{clearTimeout(closeT); el.classList.add('open');}); submenu.addEventListener('mouseleave',close); }
  });
}

/* ================== Exports ================== */
function download(filename, content){
  const blob=new Blob([content], {type:'text/plain;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); a.remove();
}
function generateExportHTML(tree, globalAnimClass){
  const css = `
/* ===== Navigation (exported) ===== */
.navbar{display:flex;gap:18px;align-items:center}
.nav-item{position:relative}
.nav-link{display:inline-flex;gap:6px;align-items:center;text-decoration:none;padding:6px 10px;border-radius:8px;transition:all .2s}
.caret{font-size:10px;opacity:.8}
.anim-underline .nav-link{position:relative}
.anim-underline .nav-link::after{content:"";position:absolute;left:10px;right:10px;bottom:3px;height:2px;background:currentColor;transform:scaleX(0);transform-origin:left;transition:transform .22s ease}
.anim-underline .nav-link:hover::after{transform:scaleX(1)}
.anim-rise .nav-link:hover{transform:translateY(-2px)}
.anim-pulse .nav-link:hover{filter:brightness(1.2)}
.nav-item > .nav-children{display:none;position:absolute;left:0;top:100%;margin-top:6px;padding:10px;list-style:none;border:1px solid #d0d7e2;border-radius:10px;background:#fff;min-width:220px;z-index:9999}
.nav-item:hover > .nav-children{display:block}
.nav-children .nav-item{position:relative}
.nav-children .nav-link{display:block;color:#0b1220}
.nav-children .nav-item + .nav-item{margin-top:4px}
.nav-children .nav-item > .nav-children{display:none;position:absolute;left:100%;top:0;margin-left:8px;margin-top:0;padding:10px;list-style:none;min-width:220px;border:1px solid #d0d7e2;border-radius:10px;background:#fff;z-index:9999}
.nav-children .nav-item:hover > .nav-children{display:block}
@media (prefers-color-scheme: dark){
  .nav-children{ background:#0d1529; border-color:#243453; }
  .nav-children .nav-link{ color:#e5e7eb; }
}`.trim();

  const animToClass=(choice)=>({underline:'anim-underline',rise:'anim-rise',pulse:'anim-pulse',none:''}[choice]||'');
  const build=(items)=>items.map(it=>{
    const hasKids = Array.isArray(it.children) && it.children.length>0;
    const caret = hasKids ? '<span class="caret">‚ñæ</span>' : '';
    const link = `<a class="nav-link" href="${escapeHtml(it.href||'#')}" target="${it.target||'_self'}" style="color:${it.color||'inherit'};background:${it.bg||'transparent'}">${escapeHtml(it.label||'Untitled')}${caret}</a>`;
    const inner = hasKids ? `<div class="nav-item">${link}<ul class="nav-children">${build(it.children).join('')}</ul></div>` : `<div class="nav-item">${link}</div>`;
    const wrapperClass = (it.anim && it.anim!=='inherit') ? animToClass(it.anim) : '';
    return wrapperClass ? `<div class="${wrapperClass}">${inner}</div>` : inner;
  });
  const classes=['navbar']; if(globalAnimClass) classes.push(globalAnimClass);
  const html = `<nav class="${classes.join(' ')}">\n  ${build(tree).join('\n  ')}\n</nav>`;
  return { html, css };
}
function generateExportCC(tree){
  let nextId = 1;
  function mapChild(node, order){
    const hasKids = Array.isArray(node.children) && node.children.length > 0;
    const isContainer = hasKids && (!node.href || node.href==="#" );
    const mapped = {
      id: nextId++,
      displayOrder: String(order),
      title: node.label || 'Untitled',
      url: node.href || "",
      type: 1,
      description: "",
      heroImage: "",
      thumbnailImage: "",
      showDescriptionOnHomepage: false,
      replyCount: 0,
      children: [],
      topicsOrder: [],
      isCollapsed: false,
      metaRobots: "index,follow",
      seoTitle: "",
      seoDescription: "",
      hideFromSearch: false,
      includeForStats: true,
      parentId: null,
      isContainer,
      roles: Array.isArray(node.roles) ? node.roles : []
    };
    if(hasKids){ mapped.children = node.children.map((ch, idx)=> mapChild(ch, idx+1)); }
    return mapped;
  }
  const nonEmptyRoots = tree.filter(r => Array.isArray(r.children) && r.children.length > 0);
  return nonEmptyRoots.map((root, idx)=>({
    key: "custom-dropdown",
    position: root.position ?? (idx+10),
    visibility: true,
    name: root.label || `Menu ${idx+1}`,
    roles: Array.isArray(root.roles) ? root.roles : [],
    children: (root.children||[]).map((ch, i)=> mapChild(ch, i+1))
  }));
}
function getCCAnimationCSS(){
  return `
/* ===== Optional Hover Animation Utilities for Gainsight CC Header ===== */
.anim-underline .main-menu-link,
.anim-underline .header-navigation_link { position: relative; }
.anim-underline .main-menu-link::after,
.anim-underline .header-navigation_link::after {
  content:""; position:absolute; left:8px; right:8px; bottom:3px; height:2px;
  background: currentColor; transform: scaleX(0); transform-origin:left;
  transition: transform .22s ease;
}
.anim-underline .main-menu-link:hover::after,
.anim-underline .header-navigation_link:hover::after { transform: scaleX(1); }
.anim-rise .main-menu-link:hover,
.anim-rise .header-navigation_link:hover { transform: translateY(-2px); transition: transform .2s ease; }
.anim-pulse .main-menu-link:hover,
.anim-pulse .header-navigation_link:hover { filter: brightness(1.2); transition: filter .2s ease; }`.trim();
}
els.exportJson?.addEventListener('click', ()=> download('menu.json', JSON.stringify(menu,null,2)));
els.exportHtml?.addEventListener('click', ()=>{
  const {html,css}=generateExportHTML(menu, els.globalAnim.value);
  const bundle=`<!-- Navigation HTML -->\n${html}\n\n<!-- Navigation CSS -->\n<style>\n${css}\n</style>\n`;
  download('navigation.html', bundle);
});
els.exportCC.addEventListener('click', ()=>{
  const cc  = generateExportCC(menu);
  const css = getCCAnimationCSS();
  const closingScript = '</scr' + 'ipt>';
  const headBundle = [
    '<!-- Gainsight Customer Community custom menu (insert into <HEAD>) -->',
    '<script>',
    'window.customMegaMenuItems = ' + JSON.stringify(cc, null, 2) + ';',
    closingScript,
    '',
    '<!-- Optional: hover animation utilities (enable by adding class="anim-underline" / "anim-rise" / "anim-pulse") -->',
    '<style>',
    css,
    '</style>',
    ''
  ].join('\n');
  download('customMegaMenuItems_head_snippet.html', headBundle);
});
if (els.moreBtn && els.moreMenu){
  els.moreBtn.addEventListener('click', (e)=>{ e.stopPropagation(); els.moreMenu.parentElement.classList.toggle('open'); });
  document.addEventListener('click', ()=> els.moreMenu.parentElement.classList.remove('open'));
}

/* ================== Resizable Split ================== */
const splitKey = 'nav_builder_left_px';
function setLeft(px){ const min=360, max=Math.max(min, window.innerWidth-420); const clamped=Math.min(Math.max(px,min),max); document.documentElement.style.setProperty('--left', clamped + 'px'); return clamped; }
function loadLeft(){ const saved=parseInt(localStorage.getItem(splitKey),10); if(!isNaN(saved)) setLeft(saved); else setLeft(560); }
function startDrag(clientX){
  const startX=clientX; const startLeft=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--left'))||560;
  function onMove(e){ const x=e.touches?e.touches[0].clientX:e.clientX; setLeft(startLeft + (x-startX)); }
  function onUp(){ const cur=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--left'))||560; localStorage.setItem(splitKey,String(cur));
    window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp);
    window.removeEventListener('touchmove', onMove); window.removeEventListener('touchend', onUp);
  }
  window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
  window.addEventListener('touchmove', onMove, {passive:false}); window.addEventListener('touchend', onUp);
}
if (els.divider){
  els.divider.addEventListener('mousedown', (e)=>{ e.preventDefault(); startDrag(e.clientX); });
  els.divider.addEventListener('touchstart', (e)=>{ e.preventDefault(); startDrag(e.touches[0].clientX); }, {passive:false});
  els.divider.addEventListener('dblclick', ()=>{ const px=setLeft(560); localStorage.setItem(splitKey, String(px)); });
  window.addEventListener('resize', ()=>{ const cur=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--left'))||560; const clamped=setLeft(cur); localStorage.setItem(splitKey, String(clamped)); });
}

/* ================== Import UI ================== */
els.importMode.addEventListener('change', ()=>{
  const mode = els.importMode.value;
  els.fileMode.classList.toggle('hidden', mode!=='file');
  els.pasteMode.classList.toggle('hidden', mode!=='paste');
});
els.runImport.addEventListener('click', ()=>{
  const mode = els.importMode.value;
  if (mode === 'file') {
    const f = els.htmlFile.files?.[0];
    if(!f) return alert('Choose an HTML file first.');
    const fr = new FileReader();
    fr.onload = () => applyImported(importFromHtmlString(String(fr.result||'')));
    fr.readAsText(f);
  } else {
    const html = els.htmlPaste.value.trim();
    if(!html) return alert('Paste some HTML first.');
    applyImported(importFromHtmlString(html));
  }
});

/* ================== HTML Import (Gainsight-only, with section grouping) ================== */
function importFromHtmlString(html){
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const headerUL =
    doc.querySelector('nav .header-navigation-items_menu') ||
    doc.querySelector('.header-navigation-items_menu');

  if (!headerUL) {
    setStatus('Could not find Gainsight header UL (.header-navigation-items_menu)');
    return [];
  }
  return importFromHeaderUL(headerUL);
}

function importFromHeaderUL(ul){
  const items = [];
  const lis = Array.from(ul.querySelectorAll(':scope > li'));

  lis.forEach(li => {
    // Mega menu entry (e.g., "Product Forums")
    if (li.classList.contains('main-menu') || li.querySelector(':scope .dropdown-container')) {
      const label = textFromButton(li) || 'Menu';
      const dropdownRoot =
        li.querySelector(':scope .dropdown--forums-overview') ||
        li.querySelector(':scope .dropdown') ||
        li.querySelector(':scope .dropdown-container ul');

      const children = dropdownRoot ? walkDropdownLists(dropdownRoot) : [];
      items.push(mkItem(label, '#', '_self', children));
    } else {
      // Plain top-level link (Resources, Groups, Events, Support...)
      const a = li.querySelector(':scope > a.header-navigation_link, :scope > a');
      if (!a) return;
      items.push(mkItem(cleanLabel(a.textContent), a.getAttribute('href') || '#', a.target || '_self', []));
    }
  });

  return items;
}

/**
 * Walk the Product Forums dropdown and build:
 * - quick links (Community / Recently active / Unanswered)
 * - grouped sections: anchors with <strong> become section parents,
 *   subsequent non-strong items become children until next section header
 * - preserve true nested submenus (Welcome ‚Üí Getting started; Admins Section ‚Üí ‚Ä¶)
 */
function walkDropdownLists(dropdownRoot){
  const quickLinksUL = dropdownRoot.querySelector(':scope .main-menu-list--quicklinks');
  const mainListUL   = dropdownRoot.querySelector(':scope .main-menu-list:not(.main-menu-list--quicklinks)') ||
                       dropdownRoot.querySelector(':scope ul:not(.main-menu-list--quicklinks)');

  const result = [];

  // Quick links
  if (quickLinksUL) {
    const qlis = Array.from(quickLinksUL.querySelectorAll(':scope > li'));
    qlis.forEach(li => {
      const a = li.querySelector(':scope a');
      if (!a) return;
      result.push(mkItem(cleanLabel(textFromAnchor(a)), a.getAttribute('href') || '#', a.target || '_self', []));
    });
  }

  // Section grouping
  if (mainListUL) {
    const lis = Array.from(mainListUL.querySelectorAll(':scope > li'));
    let currentSection = null;

    lis.forEach(li => {
      const a = li.querySelector(':scope a.main-menu-link, :scope a.main-menu-link--category, :scope a.link--text, :scope a');
      if (!a) return;

      const isSectionHeader = !!a.querySelector('strong, .main-menu-link__name strong');
      const label = cleanLabel(textFromAnchor(a));
      const href  = a.getAttribute('href') || '#';
      const tgt   = a.target || '_self';

      // nested flyout (Welcome / Admins Section)
      const nestedFlyout = li.querySelector(':scope .dropdown--forums-overview--nested');

      const thisItem = mkItem(label, href, tgt, []);

      if (nestedFlyout) {
        thisItem.children = walkDropdownLists(nestedFlyout);
      } else {
        // direct child ULs belonging to THIS li (rare)
        const childULs = Array.from(li.querySelectorAll(':scope ul')).filter(cul => cul.closest('li') === li);
        childULs.forEach(cul => thisItem.children.push(...walkSimpleUL(cul)));
      }

      if (isSectionHeader) {
        currentSection = thisItem;
        result.push(currentSection);
      } else if (currentSection) {
        currentSection.children.push(thisItem);
      } else {
        result.push(thisItem); // before any section header
      }
    });
  }

  return result;
}

/* ---------- Tiny helpers ---------- */
function mkItem(label, href, target, children){
  return { id: uid(), label, href, target, color:'#e5e7eb', bg:'', anim:'inherit', roles:[], children: children || [] };
}
function cleanLabel(txt){
  return (txt||'').trim().replace(/\s*(\(\d+\)|¬∑\s*\d+|\d+)\s*$/,'') || 'Untitled';
}
function textFromButton(scope){
  const trigger = scope.querySelector(':scope .main-menu-trigger span, :scope button span');
  return trigger ? trigger.textContent : (scope.querySelector('button')?.textContent || '');
}
function textFromAnchor(a){
  const strong = a.querySelector('.main-menu-link__name, strong');
  return strong ? strong.textContent : a.textContent || '';
}

/* Simple UL walker used only for true nested submenus under a single LI */
function walkSimpleUL(ul){
  const items = [];
  Array.from(ul.querySelectorAll(':scope > li')).forEach(li => {
    const a = li.querySelector(':scope a');
    if (!a) return;
    const child = mkItem(cleanLabel(textFromAnchor(a)), a.getAttribute('href') || '#', a.target || '_self', []);
    const deeper = li.querySelector(':scope ul');
    if (deeper) child.children.push(...walkSimpleUL(deeper));
    items.push(child);
  });
  return items;
}

/* ================== Apply imported ================== */
function applyImported(imported){
  if(!Array.isArray(imported) || !imported.length){
    setStatus('No items found in HTML'); return;
  }
  if(els.replaceCurrent.checked){ menu = imported; }
  else { menu = menu.concat(imported); }
  save(); renderAll(); historyPush(menu);
  setStatus('Imported');
}

/* ================== Boot & Reset ================== */
els.addRoot.addEventListener('click', ()=>addItem(null));
els.reset.addEventListener('click', ()=>{ if(confirm('Reset to empty?')){ menu=[]; save(); renderAll(); historyPush(menu); }});
if (els.moreBtn && els.moreMenu){
  els.moreBtn.addEventListener('click', (e)=>{ e.stopPropagation(); els.moreMenu.parentElement.classList.toggle('open'); });
  document.addEventListener('click', ()=> els.moreMenu.parentElement.classList.remove('open'));
}
function boot(){
  loadLeft();
  const cached = load(); if (cached && Array.isArray(cached)) menu = cached;
  renderAll(); initHistory();
  els.globalAnim.value = localStorage.getItem('nav_builder_global_anim') || 'anim-underline';
  els.globalAnim.addEventListener('change', ()=> localStorage.setItem('nav_builder_global_anim', els.globalAnim.value));
}
boot();
</script>
</body>
</html>
